<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BCA LAND // COMMAND CENTER</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .box { border: 1px solid #333; padding: 20px; margin-bottom: 20px; }
        input { background: #111; color: #fff; border: 1px solid #0f0; padding: 10px; width: 300px; display: block; margin-bottom: 10px; }
        button { background: #ff005a; color: white; padding: 10px 20px; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #d0004b; }
        .log { height: 300px; overflow-y: scroll; border: 1px dashed #333; padding: 10px; color: #aaa; }
        .success { color: #0f0; } .error { color: #f00; } .alert { color: #ff005a; }
    </style>
</head>
<body>
    <h1>ü§ñ BCA BOT ORCHESTRATOR</h1>
    
    <div class="box">
        <h3>1. AUTHENTICATION</h3>
        <input type="text" id="tg-token" placeholder="Telegram Bot Token (Get from @BotFather)">
        <input type="text" id="admin-id" placeholder="Your Telegram User ID (Get from @userinfobot)">
        <button onclick="handleAuthClick()">LOGIN TO GOOGLE DRIVE</button>
    </div>

    <div class="box">
        <h3>2. SYSTEM LOGS</h3>
        <div id="console" class="log">System Ready... Waiting for auth.</div>
    </div>

    <!-- Silent Audio to keep browser tab awake -->
    <audio id="bg-audio" loop>
        <source src="https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3" type="audio/mp3">
    </audio>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // --- CONFIGURATION (FILL THESE) ---
        const GOOGLE_CLIENT_ID = '164525854794-ifjc93mal53e6tj6vikaj1aqkci0ru81.apps.googleusercontent.com'; 
        const GOOGLE_API_KEY = 'AIzaSyBUK6-7P_vIrOYHQfoCmiWg6JtiV2NXqFs'; 
        const DRIVE_FOLDER_ID = '1nIjmJk1UKxsJEnMZujZ5BhZf9HW13d1S';
        const DB_FILE_ID = '1wcPqjXJyTi9m9HrZUbMHOEj78x_6_534';
        // ----------------------------------

        let tokenClient, tgToken, adminId;
        let lastUpdateId = 0;

        // --- GOOGLE AUTH ---
        function handleAuthClick() {
            tgToken = document.getElementById('tg-token').value;
            adminId = document.getElementById('admin-id').value;
            if(!tgToken || !adminId) return alert("Enter Telegram Details first!");
            
            tokenClient.requestAccessToken({prompt: ''});
        }

        window.onload = function() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            });
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (resp) => {
                    if (resp.error) return;
                    log("Google Access Granted. STARTING BOT...", "success");
                    document.getElementById('bg-audio').play(); // Keep alive
                    pollTelegram();
                }
            });
        };

        // --- TELEGRAM BOT LOGIC ---
        async function pollTelegram() {
            try {
                const url = `https://api.telegram.org/bot${tgToken}/getUpdates?offset=${lastUpdateId + 1}&timeout=30`;
                const resp = await fetch(url);
                const data = await resp.json();
                
                if (data.result) {
                    for (const update of data.result) {
                        lastUpdateId = update.update_id;
                        await processMessage(update.message);
                    }
                }
            } catch (e) { console.error(e); }
            setTimeout(pollTelegram, 1000); // Loop forever
        }

        async function processMessage(msg) {
            if (!msg || String(msg.from.id) !== String(adminId)) return;

            // 1. Handle Files
            if (msg.document || msg.photo || msg.video) {
                const fileObj = msg.document || msg.video || msg.photo[msg.photo.length - 1];
                const caption = msg.caption || ""; 
                
                // Parse Category from Hashtag (e.g. "Notes #DBMS")
                let category = "General";
                if(caption.includes("#DBMS")) category = "DBMS";
                if(caption.includes("#C")) category = "Programming in C";
                if(caption.includes("#DS")) category = "Data Structures";
                if(caption.includes("#Math")) category = "Mathematics";

                log(`üì• Receiving: ${fileObj.file_name || 'Image'} (${category})`, "alert");
                sendMessage(msg.chat.id, `‚è≥ <b>Downloading...</b>\n\nFile: ${fileObj.file_name || 'Media'}\nCategory: ${category}`);

                await handleFileUpload(fileObj, caption, category, msg.chat.id);
            }
        }

        async function handleFileUpload(fileObj, caption, category, chatId) {
            // Get Telegram File Path
            const pathRes = await fetch(`https://api.telegram.org/bot${tgToken}/getFile?file_id=${fileObj.file_id}`);
            const pathJson = await pathRes.json();
            
            if(pathJson.result.file_size > 20 * 1024 * 1024) {
                return sendMessage(chatId, "‚ùå Error: File > 20MB. Telegram blocks browser download. Use direct link.");
            }

            // Download Blob
            const fileUrl = `https://api.telegram.org/file/bot${tgToken}/${pathJson.result.file_path}`;
            const blob = await fetch(fileUrl).then(r => r.blob());

            // Upload to Drive
            const fileName = fileObj.file_name || `upload_${Date.now()}.jpg`;
            const driveFile = await uploadToDrive(blob, fileName, blob.type);

            // Update DB
            const newEntry = {
                id: driveFile.id,
                name: fileName,
                url: `/drive-viewer?id=${driveFile.id}`, // Virtual URL
                category: category,
                caption: caption.replace(/#\w+/g, "").trim(), // Remove hashtags
                size: blob.size,
                date: Math.floor(Date.now() / 1000)
            };
            await updateDatabase(newEntry);

            sendMessage(chatId, `‚úÖ <b>Deployed Successfully!</b>\n\nüìÇ Saved to: ${category}\nüîó Live on Site.`);
        }

        // --- DRIVE & DB FUNCTIONS ---
        async function uploadToDrive(blob, name, mime) {
            const accessToken = gapi.client.getToken().access_token;
            const metadata = { name: name, parents: [DRIVE_FOLDER_ID] };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            log("üöÄ Uploading to Cloud...", "alert");
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body: form
            });
            const data = await res.json();
            
            // Make Public
            await gapi.client.drive.permissions.create({
                fileId: data.id, resource: { role: 'reader', type: 'anyone' }
            });
            return data;
        }

        async function updateDatabase(newEntry) {
            log("üíæ Updating Database Manifest...", "alert");
            // 1. Get current DB
            const res = await gapi.client.drive.files.get({ fileId: DB_FILE_ID, alt: 'media' });
            let db = res.result || [];
            if(typeof db === 'string') db = JSON.parse(db);
            
            // 2. Add new entry
            db.unshift(newEntry);

            // 3. Save back
            const accessToken = gapi.client.getToken().access_token;
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${DB_FILE_ID}?uploadType=media`, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                body: JSON.stringify(db)
            });
            log("‚ú® Database Synced!", "success");
        }

        function sendMessage(chatId, text) {
            fetch(`https://api.telegram.org/bot${tgToken}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'HTML' })
            });
        }

        function log(msg, type='') {
            const div = document.createElement('div');
            div.innerHTML = `> ${msg}`;
            div.className = type;
            document.getElementById('console').prepend(div);
        }
    </script>
</body>
</html>
